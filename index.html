<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PM Monitoring Dashboard</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<style>
  body { font-family: Arial, sans-serif; background-color: #f4f6fa; margin:0; padding:20px; }
  h1 { text-align:center; color:#333; margin-bottom:20px; }
  .login-box { max-width:320px; margin:50px auto; background:#fff; padding:25px; border-radius:10px; box-shadow:0 3px 10px rgba(0,0,0,0.1); text-align:center;}
  .login-box h2 { color:#007bff; }
  .login-box button { background:#007bff; color:white; border:none; border-radius:6px; padding:10px 20px; cursor:pointer; margin-top:10px; }
  #status { margin-top:10px; font-size:14px; color:#555; }
  .container { display:flex; flex-wrap:wrap; justify-content:center; gap:20px; margin:20px; }
  .device-box { width:300px; background:white; border-radius:12px; padding:15px; text-align:center; box-shadow:0 4px 12px rgba(0,0,0,0.1);}
  .device-name { font-weight:bold; color:#007bff; font-size:18px; margin-bottom:10px; }
  .pm-values span { display:block; margin:4px 0; font-size:14px; }
  .edit-input { width:80%; padding:4px; margin:3px 0; text-align:center; border-radius:5px; border:1px solid #ccc; }
  .edit-btn { padding:4px 8px; margin:3px; border:none; background:#007bff; color:white; border-radius:5px; cursor:pointer; }
  .download-btn { background:#28a745; border:none; padding:6px 12px; color:white; border-radius:6px; cursor:pointer; margin-top:8px; } /* 🔹 NEW */
</style>
</head>
<body>

<h1>PM Monitoring Dashboard</h1>

<!-- Login Section -->
<div id="loginBox" class="login-box">
  <h2>Admin Login</h2>
  <button onclick="login()">Login as Admin</button>
  <div id="status"></div>
</div>

<!-- Dashboard Section -->
<div class="container" id="deviceContainer" style="display:none;"></div>

<script>
  // ===================== FIREBASE CONFIG =====================
  const firebaseConfig = {
    apiKey: "AIzaSyBp6Ac1Q2RhCUDuRIhvQ5MkAd-XYQHGcOk",
    authDomain: "pm-monitor-1949c.firebaseapp.com",
    databaseURL: "https://pm-monitor-1949c-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "pm-monitor-1949c",
    storageBucket: "pm-monitor-1949c.firebasestorage.app",
    messagingSenderId: "252989379253",
    appId: "1:252989379253:web:1b000622362d26fa9fe4fc",
    measurementId: "G-ZSMT3DQ9TY"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  const container = document.getElementById("deviceContainer");
  const loginBox = document.getElementById("loginBox");
  const statusText = document.getElementById("status");

  // ===================== PREDEFINED CREDENTIALS =====================
  const adminEmail = "mr.d2003feb@gmail.com";
  const adminPassword = "mahin123";

  // ===================== LOGIN FUNCTION =====================
  function login() {
    statusText.textContent = "Logging in...";
    auth.signInWithEmailAndPassword(adminEmail, adminPassword)
      .then(() => {
        statusText.textContent = "✅ Login successful!";
        loginBox.style.display = "none";
        container.style.display = "flex";
        subscribeDevices(); // Start real-time updates
      })
      .catch(error => {
        statusText.textContent = "❌ " + error.message;
      });
  }

  // ===================== FORMAT TIMESTAMP =====================
  function formatTimestamp(ts) {
    const d = new Date(ts);
    return {
      date: d.toLocaleDateString(),
      time: d.toLocaleTimeString()
    };
  }

  // ===================== SUBSCRIBE TO DEVICES =====================
  function subscribeDevices() {
    db.ref("devices").on("value", snapshot => {
      const data = snapshot.val();
      container.innerHTML = "";

      if (!data) {
        container.innerHTML = "<p>No device data available.</p>";
        return;
      }

      for (let deviceID in data) {
        const d = data[deviceID];

        let datePart = "-";
        let timePart = "-";
        if (d.latest && d.latest.timestamp) {
          datePart = d.latest.timestamp;
        }

        const box = document.createElement("div");
        box.className = "device-box";
        box.innerHTML = `
          <div class="device-name">Device: 
            <input class="edit-input" id="name-${deviceID}" value="${d.name || deviceID}">
            <button class="edit-btn" onclick="updateName('${deviceID}')">Update Name</button>
          </div>
          <div class="pm-values">
            <span>PM1.0: ${d.latest?.PM1 || "-"}</span>
            <span>PM2.5: ${d.latest?.PM25 || "-"}</span>
            <span>PM10: ${d.latest?.PM10 || "-"}</span>
            <span><b>Last Log:</b> ${datePart}</span>
            <span>
              Interval (s): 
              <input class="edit-input" id="interval-${deviceID}" type="number" min="1" value="${d.interval || 10}">
              <button class="edit-btn" onclick="updateInterval('${deviceID}')">Update</button>
            </span>
            <button class="download-btn" onclick="downloadCSV('${deviceID}')">⬇ Download CSV</button> <!-- 🔹 NEW -->
          </div>
        `;
        container.appendChild(box);
      }
    });
  }

  // ===================== UPDATE NAME =====================
  function updateName(deviceID) {
    const input = document.getElementById(`name-${deviceID}`);
    const newName = input.value.trim();
    if(newName) {
      db.ref(`devices/${deviceID}/name`).set(newName)
        .then(() => alert(`Name updated to ${newName}`))
        .catch(err => alert("Error updating name: "+err));
    } else {
      alert("Name cannot be empty");
    }
  }

  // ===================== UPDATE INTERVAL =====================
  function updateInterval(deviceID) {
    const input = document.getElementById(`interval-${deviceID}`);
    const val = parseInt(input.value);
    if(val >= 1) {
      db.ref(`devices/${deviceID}/interval`).set(val)
        .then(() => alert(`Interval updated to ${val} s`))
        .catch(err => alert("Error updating interval: "+err));
    } else {
      alert("Interval must be at least 1 second");
    }
  }

  // ===================== DOWNLOAD LOGS AS CSV =====================  🔹 NEW
  async function downloadCSV(deviceID) {
    try {
      const snapshot = await db.ref(`devices/${deviceID}/logs`).once("value");
      const data = snapshot.val();
      if (!data) {
        alert("No log data available for this device!");
        return;
      }

      let csv = "Timestamp,PM1,PM2.5,PM10\n";
      for (let key in data) {
        const entry = data[key];
        csv += `${entry.timestamp || key},${entry.PM1 || ""},${entry.PM25 || ""},${entry.PM10 || ""}\n`;
      }

      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${deviceID}_logs.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    } catch (err) {
      alert("Error downloading CSV: " + err.message);
    }
  }

</script>

</body>
</html>
