<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PM Monitoring Dashboard</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<style>
  body { font-family: Arial, sans-serif; background-color: #f4f6fa; margin:0; padding:20px; }
  h1 { text-align:center; color:#333; margin-bottom:20px; }
  .login-box { max-width:320px; margin:50px auto; background:#fff; padding:25px; border-radius:10px; box-shadow:0 3px 10px rgba(0,0,0,0.1); text-align:center;}
  .login-box h2 { color:#007bff; }
  .login-box button { background:#007bff; color:white; border:none; border-radius:6px; padding:10px 20px; cursor:pointer; margin-top:10px; }
  #status { margin-top:10px; font-size:14px; color:#555; }
  .container { display:flex; flex-wrap:wrap; justify-content:center; gap:20px; margin:20px; }
  .device-box { width:300px; background:white; border-radius:12px; padding:15px; text-align:center; box-shadow:0 4px 12px rgba(0,0,0,0.1);}
  .device-name { font-weight:bold; color:#007bff; font-size:18px; margin-bottom:10px; }
  .pm-values span { display:block; margin:4px 0; font-size:14px; }
</style>
</head>
<body>

<h1>PM Monitoring Dashboard</h1>

<!-- Login Section -->
<div id="loginBox" class="login-box">
  <h2>Admin Login</h2>
  <button onclick="login()">Login as Admin</button>
  <div id="status"></div>
</div>

<!-- Dashboard Section -->
<div class="container" id="deviceContainer" style="display:none;"></div>

<script>
  // ===================== FIREBASE CONFIG =====================
  const firebaseConfig = {
    apiKey: "AIzaSyBp6Ac1Q2RhCUDuRIhvQ5MkAd-XYQHGcOk",
    authDomain: "pm-monitor-1949c.firebaseapp.com",
    databaseURL: "https://pm-monitor-1949c-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "pm-monitor-1949c",
    storageBucket: "pm-monitor-1949c.firebasestorage.app",
    messagingSenderId: "252989379253",
    appId: "1:252989379253:web:1b000622362d26fa9fe4fc",
    measurementId: "G-ZSMT3DQ9TY"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  const container = document.getElementById("deviceContainer");
  const loginBox = document.getElementById("loginBox");
  const statusText = document.getElementById("status");

  // ===================== PREDEFINED CREDENTIALS =====================
  const adminEmail = "mr.d2003feb@gmail.com";
  const adminPassword = "mahin123";

  // ===================== LOGIN FUNCTION =====================
  function login() {
    statusText.textContent = "Logging in...";
    auth.signInWithEmailAndPassword(adminEmail, adminPassword)
      .then(() => {
        statusText.textContent = "✅ Login successful!";
        loginBox.style.display = "none";
        container.style.display = "flex";
        loadData();
        setInterval(loadData, 5000); // Auto-refresh every 5s
      })
      .catch(error => {
        statusText.textContent = "❌ " + error.message;
      });
  }

  // ===================== FORMAT TIMESTAMP =====================
  function formatTimestamp(ts) {
    const d = new Date(ts);
    return {
      date: d.toLocaleDateString(),
      time: d.toLocaleTimeString()
    };
  }

  // ===================== LOAD DEVICE DATA =====================
  function loadData() {
    db.ref("devices").once("value").then(snapshot => {
      const data = snapshot.val();
      container.innerHTML = "";

      if (!data) {
        container.innerHTML = "<p>No device data available.</p>";
        return;
      }

      for (let deviceID in data) {
        const d = data[deviceID];

        let datePart = "-";
        let timePart = "-";
        if (d.timestamp) {
          const f = formatTimestamp(d.timestamp);
          datePart = f.date;
          timePart = f.time;
        }

        const box = document.createElement("div");
        box.className = "device-box";
        box.innerHTML = `
          <div class="device-name">${d.name || deviceID}</div>
          <div class="pm-values">
            <span>PM1.0: ${d.PM1 || "-"}</span>
            <span>PM2.5: ${d.PM25 || "-"}</span>
            <span>PM10: ${d.PM10 || "-"}</span>
            <span><b>Date:</b> ${datePart}</span>
            <span><b>Time:</b> ${timePart}</span>
            <span><b>Interval:</b> ${d.interval || "-"}s</span>
          </div>
        `;
        container.appendChild(box);
      }
    }).catch(err => console.error("Firebase read error:", err));
  }
</script>

</body>
</html>
